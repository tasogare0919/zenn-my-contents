---
title: "Terraform ã§ statelock ã‚’è§£é™¤ã™ã‚‹"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Terraform]
published: true
---
# æ¦‚è¦
Terraform ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦`tfstate`ã‚’ S3 ã«ã— `statelock` ã‚’ DynamoDB ã§ä½¿ã£ã¦ã„ã¾ã™.ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å¤‰æ›´ã‚’`terraform apply`ã—ã‚ˆã†ã¨ã—ã¦èª¤ã£ã¦ã„ã‚‹ç®‡æ‰€ã‚’è¦‹ã¤ã‘ãŸã®ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå¾Œã€`terraform plan`ã‚’ã—ãŸã‚‰`Error: Error acquiring the state lock`ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã§ã¾ã—ãŸ.

*ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸*

```sh
 % terraform apply
Terraform will perform the following actions:

~ä¸­ç•¥~

Plan: 0 to add, 1 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: ^C^CERRO[0051] got 3 SIGTERM/SIGINTs, forcing shutdown      

% terraform plan 
â•·
â”‚ Error: Error acquiring the state lock
â”‚ 
â”‚ Error message: ConditionalCheckFailedException: The conditional request failed
â”‚ Lock Info:
â”‚   ID:        xxxx-xxxx-xxxx-xxxx-xxxx
â”‚   Path:      xxx/xxx.tfstate
â”‚   Operation: OperationTypeApply
â”‚   Who:       xxxx@xxxx
â”‚   Version:   1.0.3
â”‚   Created:   2021-07-23 02:55:43.1115469 +0000 UTC
â”‚   Info:      
â”‚ 
```

# å¯¾å¿œ
èª¿ã¹ã¦ã¿ã‚‹ã¨,ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã«ãªã£ã¦ã—ã¾ã„ä¸Šè¨˜ã®ã‚ˆã†ã«`terraform plan/apply`ãªã©ã§ããªããªã‚‹ãŸã‚ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™.`terraform force-unlock` ã‚’å®Ÿè¡Œã™ã‚Œã°è§£é™¤ãŒã§ãã¾ã™.ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨,ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ã‚¤ãƒ³ãƒ•ãƒ©ã‚‚å¤‰æ›´ã—ãªã„ã‚³ãƒãƒ³ãƒ‰ã¨ã®ã“ã¨ã§ã™.

>Manually unlock the state for the defined configuration.
>
>This will not modify your infrastructure. This command removes the lock on the state for the current configuration. The behavior of this lock is dependent on the backend being used. Local state files cannot be unlocked by another process.

```sh
% terraform force-unlock xxxx-xxxx-xxxx-xxxx-xxxx(ID æƒ…å ±)
Do you really want to force-unlock?
  Terraform will remove the lock on the remote state.
  This will allow local Terraform commands to modify this state, even though it
  may be still be in use. Only 'yes' will be accepted to confirm.

  Enter a value: yes

Terraform state has been successfully unlocked!

The state has been unlocked, and Terraform commands should now be able to
obtain a new lock on the remote state.
```

ãƒ­ãƒƒã‚¯ã‚’è§£é™¤å¾Œ,`terraform plan/apply`ãŒæˆåŠŸã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ.

```sh
% terraform plan
~ä¸­ç•¥~

Plan: 0 to add, 1 to change, 0 to destroy.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you run "terraform apply" now.
% terraform apply
~ä¸­ç•¥~

Plan: 0 to add, 1 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

~ä¸­ç•¥~
Apply complete! Resources: 0 added, 1 changed, 0 destroyed.
```

# ã¾ã¨ã‚
åˆã‚ã¦ã®ä½“é¨“ã§å‹‰å¼·ã«ãªã£ãŸãŸã‚å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã™.

# å‚è€ƒæƒ…å ±
https://qiita.com/tomy103rider/items/b1dec92aaa57b9af31d9
https://www.terraform.io/docs/cli/commands/force-unlock.html