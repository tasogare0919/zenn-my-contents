---
title: "FireLens ã® JSON ãƒ­ã‚°ã‚’ Athena ã§ã‚¯ã‚¨ãƒªã™ã‚‹"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [AWS,Athena,ECS,FireLens]
published: true
---
å‰å›ã®è¨˜äº‹ã§ FireLens çµŒç”±ã§é€ã‚‰ã‚ŒãŸãƒ­ã‚°ã‹ã‚‰ S3 ã«å¿…è¦ãªãƒ­ã‚°ã ã‘æŠ½å‡ºã—ã¾ã—ãŸ.ä»Šå›ã¯ Athena ã§ãã®ãƒ­ã‚°ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ä½œã£ã¦ã‚¯ã‚¨ãƒªã‚’æŠ•ã’ã¦ã¿ã¾ã™.

https://zenn.dev/sadayoshitada/articles/2105202244_article

# å¯¾è±¡ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä¸­èº«
S3 ã«ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¬¡ã®ã‚ˆã†ãªå½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ãŒ,ã“ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ã‚¨ãƒªã§ãã‚‹ã‚ˆã†ã«ãƒ†ãƒ¼ãƒ–ãƒ«ä½œã‚Šã¾ã™.

```json
{
    "request_headers": {
        "x-forwarded-for": "xx.xx.xx.xx",
        "x-forwarded-proto": "http",
        "x-forwarded-port": "xxxx",
        "host": "xx.xx.xx.xx:xxxx"
    },
    "remote_addr": "xx.xx.xx.xx",
    "request_uri": "/",
    "request_method": "GET",
    "request_time": "2021/05/20 15:17:02",
    "response_time": "0.0004",
    "status": 200,
    "response_headers": {
        "content-length": "xx",
        "content-type": "application/json"
    }
}
```

# Athena ã®ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¯ã‚¨ãƒª
Athena ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä¸‹è¨˜ã®ã‚¯ã‚¨ãƒªã§ä½œã‚Šã¾ã—ãŸ.JSON ã®ä¸­ã§å†…åŒ…ã•ã‚Œã¦ã„ã‚‹ JSON ã«ã‚‚ã‚¯ã‚¨ãƒªã§ãã‚‹ã‚ˆã† `struct` ä»¥é™ã§å®šç¾©ã—ã¦ã„ã¾ã™.ã¾ãŸ,ãƒ­ã‚°ã¯`YYYY/MM/DD`ã®ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã«å…¥ã£ã¦ã„ã‚‹ã®ã§,Partition Projection ã‚’ä½¿ã£ã¦ã„ã¾ã™.

```sql
CREATE EXTERNAL TABLE IF NOT EXISTS `partition_table`(
  `request_headers` struct<`x-forwarded-for`:string,`x-forwarded-proto`:string,`x-forwarded-port`:string,`host`:string>, 
  `remote_addr` string, 
  `request_uri` string , 
  `request_method` string , 
  `request_time` string , 
  `response_time` string , 
  `status` bigint , 
  `response_headers` struct<`content-length`:string, `content-type`:string>
  )
PARTITIONED BY (
  `dateday` string 
)
ROW FORMAT SERDE 
  'org.openx.data.jsonserde.JsonSerDe'
LOCATION
  's3://ãƒã‚±ãƒƒãƒˆå/ãƒ‘ã‚¹'
TBLPROPERTIES (
  'has_encrypted_data'='false',
  'projection.enabled' = 'true',
  'projection.dateday.type' = 'date',
  'projection.dateday.range' = '2021/05/20,NOW',
  'projection.dateday.format' = 'yyyy/MM/dd',
  'projection.dateday.interval' = '1',
  'projection.dateday.interval.unit' = 'DAYS',
  'storage.location.template' = 's3://ãƒã‚±ãƒƒãƒˆå/ãƒ‘ã‚¹/${dateday}'
);
```

## ã‚¯ã‚¨ãƒªã‚’æŠ•ã’ã¦ã¿ã‚‹
ä½œã£ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’æŠ•ã’ã¦ã¿ã¾ã™.

```sql
SELECT * FROM "xxx"."partition_table" where dateday = '2021/05/20';
```

ã“ã‚“ãªæ„Ÿã˜ã§è¿”ã£ã¦ãã¾ã™.

```text
1	{x-forwarded-for=null, x-forwarded-proto=null, x-forwarded-port=null, host=xx.xx.xx.xx:xxxx}	xx.xx.xx.xx	/	GET	2021/05/20 09:41:18	0.0005	200	{content-length=xx, content-type=application/json}	2021/05/20
2	{x-forwarded-for=null, x-forwarded-proto=null, x-forwarded-port=null, host=xx.xx.xx.xx:xxxx}	xx.xx.xx.xx	/	GET	2021/05/20 11:59:25	0.0004	200	{content-length=xx, content-type=application/json}	2021/05/20
3	{x-forwarded-for=null, x-forwarded-proto=null, x-forwarded-port=null, host=xx.xx.xx.xx:xxxx}	xx.xx.xx.xx	/	GET	2021/05/20 09:18:47	0.0004	200	{content-length=xx, content-type=application/json}	2021/05/20
```

å†…åŒ…ã•ã‚Œã¦ã„ã‚‹ JSON ã«ã‚¯ã‚¨ãƒªã—ã¦ã¿ã¾ã™.ä¾‹ãˆã°,`request_header`ã®ä¸­ã«ã‚ã‚‹`host`ã‚’ã‚¯ã‚¨ãƒªã—ã¦ã¿ã¾ã™.

```sql
SELECT request_headers."host" FROM "xxx"."partition_table" where dateday = '2021/05/20';
```

ã“ã‚Œã§`host`ã«ã¯ã„ã£ã¦ã„ã‚‹ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã ã‘è¿”ã£ã¦ãã¾ã™.ã“ã‚Œã§ãƒ­ã‚°ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’ã‚¯ã‚¨ãƒªã—ã¦ããã†ã§ã™.

```text
1	xx.xx.xx.xx:xxxx
2	xx.xx.xx.xx:xxxx
3	xx.xx.xx.xx:xxxx
```

# å‚è€ƒæƒ…å ±
https://docs.aws.amazon.com/ja_jp/athena/latest/ug/partition-projection.html