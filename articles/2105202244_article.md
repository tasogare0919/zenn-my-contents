---
title: "FireLens ã«æµã‚Œã‚‹ãƒ­ã‚°ã‚’ Lambda ã§æŠ½å‡ºã™ã‚‹"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [AWS,Lambda,Python]
published: true
---
ECS ã«ä¹—ã£ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’ FireLens ã‚’çµŒç”±ã—ã¦ Kinesis Firehose -> S3 ã«ãƒ­ã‚°ã‚’å‡ºã—ã¾ã—ãŸ.ãŸã ,ä¸‹è¨˜ã® JSON å½¢å¼ã§ãƒ­ã‚°ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚,Athena ã§ã‚¯ã‚¨ãƒªã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã—ã¦ã‚‚ãƒ­ã‚°ã®è©³ç´°ã‚’è¦‹ã‚‹æ™‚è¾›ã„ãªã¨æ€ã£ã¦ã„ã¾ã—ãŸ.

```json
{
    "container_id": "xxx",
    "container_name": "xxx",
    "ecs_cluster": "xxx",
    "ecs_task_arn": "arn:aws:ecs:xxx:xxx:task/xxx/xxx",
    "ecs_task_definition": "xxx:xxx",
    "log": "xxx"
}
```

ãã“ã§,Lambda ã‚’ä½¿ã£ã¦ `log` ã®éƒ¨åˆ†ã ã‘æŠ½å‡ºã—ã¦ S3 ã«ä¿å­˜ã—ãŸã„ã¨æ€ã£ã¦ã‚„ã£ã¦ã¿ã¾ã—ãŸ.

# ãƒ­ã‚°ã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰
Lambda ã¯ Python 3.8 ã§æ›¸ã„ã¦ã„ã‚‹ã®ã§ã™ãŒ,ãƒ­ã‚°ã‚’æŠ½å‡ºã—,S3ã«ä¿å­˜ã™ã‚‹ã¨ã“ã‚ã®ã¿ã®éƒ¨åˆ†ã‚’æŠœç²‹ã—ã¦ã¾ã™.S3 ã«ã¯ `hoge/yyyy/mm/dd/ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å_yyyymmddhhmmss.log` ã®ãƒ•ã‚¡ã‚¤ãƒ«åã§ä¿å­˜ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã¾ã™.

```python
import json
import boto3
import base64
from botocore.exceptions import ClientError
import datetime

s3 = boto3.resource('s3')
BUCKET_NAME = 'ä¿å­˜ã—ãŸã„ãƒã‚±ãƒƒãƒˆå'
DATE=datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=9)))
YEAR=DATE.strftime('%Y')
MONTH=DATE.strftime('%m')
DAY=DATE.strftime('%d')
HOUR=DATE.strftime('%H')
MIN=DATE.strftime('%M')
SEC=DATE.strftime('%S')

def lambda_handler(event, context):  
    log_output = []  
    for record in event['records']:
        payload = json.loads(base64.b64decode(record['data']))
        log_detail = payload["log"]
        log_output.append(log_detail)
        key = 'ãƒ•ã‚¡ã‚¤ãƒ«å_' + YEAR + MONTH + DAY + HOUR + MIN + SEC
        with open('/tmp/'+ key +'', 'w') as f:
            for detail in log_output:
                f.write("%s\n" % detail)
        f.close()
        path = 'hoge' + '/' + YEAR + '/' + MONTH + '/' + DAY + '/' + key + '.log'
        s3.meta.client.upload_file('/tmp/'+ key +'', BUCKET_NAME, path)
```

## S3 ã«ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
S3 ã«ä¿å­˜ã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä¸‹è¨˜ã®ç”»åƒã¿ãŸãæŒ‡å®šã—ãŸãƒ‘ã‚¹ã§å¹´æœˆæ—¥ã§ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œã‚‰ã‚Œ,ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œã‚‰ã‚Œã¾ã™.

![](https://storage.googleapis.com/zenn-user-upload/qmuvob1gio8fku30sg2y35v2fjkk)

ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¨,ãƒ­ã‚°è©³ç´°ã ã‘ãŒä¿å­˜ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã“ã‚Œã§ Athena ã§ã„ã„æ„Ÿã˜ã«ã‚¯ã‚¨ãƒªã—ã¦ã„ã‘ãã†ã§ã™.

```json
{
    "request_headers": {
        "host": "xx.xx.xx.xx:xx",
        "user-agent": "ELB-HealthChecker/2.0",
    },
    "remote_addr": "xx.xx.xx.xx",
    "request_uri": "/",
    "request_method": "GET",
    "request_time": "2021/05/20 06:30:39",
    "response_time": "0.0004",
    "response_status": 200
}
```

### å‚è€ƒæƒ…å ±
https://docs.aws.amazon.com/ja_jp/firehose/latest/dev/data-transformation.html#data-transformation-status-model

